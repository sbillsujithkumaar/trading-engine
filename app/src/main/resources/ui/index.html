<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Trading Engine</title>
</head>

<body style="font-family: monospace; margin: 24px;">

<!-- Minimal UI for correctness checks:
     - submit arbitrary orders (side/price/qty)
     - view full order book dump
     - view recent trades
-->

<h2>Trading Engine (Local Demo)</h2>

<p>
  Connected to: <span id="serverHost"></span><br/>
  Server files: <code>./data/commands.log</code>, <code>./data/trades.csv</code> (on server)
</p>

<div>
  Health: <span id="health">...</span> |
  Ready: <span id="ready">...</span> |
  Clients: <span id="clients">...</span>
</div>

<hr/>

<h3>Submit Order</h3>

<div>
  Side:
  <select id="side">
    <option>BUY</option>
    <option>SELL</option>
  </select>

  Price:
  <input id="price" type="number" value="101" style="width:90px;"/>

  Qty:
  <input id="qty" type="number" value="5" style="width:70px;"/>

  <button onclick="submitOrder()">Submit</button>
</div>

<p id="result"></p>

<hr/>

<h3>Order Book (Full Dump)</h3>
<pre id="book" style="border:1px solid #ccc; padding:10px; height:260px; overflow:auto;"></pre>

<h3>Recent Trades</h3>
<pre id="trades" style="border:1px solid #ccc; padding:10px; height:180px; overflow:auto;"></pre>

<h3>Live Feed (WebSocket)</h3>
<pre id="feed" style="border:1px solid #ccc; padding:10px; height:180px; overflow:auto;"></pre>

<script>
  const wsUrl = "ws://" + location.host + "/ws";
  const feed = document.getElementById("feed");
  document.getElementById("serverHost").textContent = location.host;

  function append(line) {
    feed.textContent += line + "\n";
    feed.scrollTop = feed.scrollHeight;
  }

  async function pollStatus() {
    try {
      document.getElementById("health").textContent = (await (await fetch("/health")).text()).trim();
      document.getElementById("ready").textContent  = (await (await fetch("/ready")).text()).trim();

      const metrics = (await (await fetch("/metrics")).text()).trim().split(/\n+/);
      const map = {};
      for (const ln of metrics) {
        const parts = ln.split(/\s+/);
        if (parts.length >= 2) map[parts[0]] = parts[1];
      }
      document.getElementById("clients").textContent = map.connected_clients ?? "?";
    } catch (e) {
      document.getElementById("health").textContent = "down";
      document.getElementById("ready").textContent = "down";
    }
  }

  async function refreshBookAndTrades() {
    document.getElementById("book").textContent = await (await fetch("/api/book")).text();
    document.getElementById("trades").textContent = await (await fetch("/api/trades?limit=50")).text();
  }

  async function submitOrder() {
    const side = document.getElementById("side").value;
    const price = parseInt(document.getElementById("price").value, 10);
    const quantity = parseInt(document.getElementById("qty").value, 10);

    const res = await fetch("/api/order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ side, price, quantity })
    });

    const body = await res.json();
    document.getElementById("result").textContent =
      res.ok ? ("Accepted orderId=" + body.orderId + " trades=" + body.trades)
             : ("Rejected: " + body.error);

    await refreshBookAndTrades();
    await pollStatus();
  }

  function connectWS() {
    const ws = new WebSocket(wsUrl);
    ws.onopen = () => append("[ws] connected");
    ws.onmessage = (ev) => append(ev.data);
    ws.onclose = () => { append("[ws] disconnected. retrying..."); setTimeout(connectWS, 1000); };
  }

  pollStatus();
  refreshBookAndTrades();
  connectWS();

  setInterval(pollStatus, 2000);
  setInterval(refreshBookAndTrades, 2000);
</script>

</body>
</html>
